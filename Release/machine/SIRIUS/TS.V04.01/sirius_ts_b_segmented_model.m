function [model, model_length] = sirius_ts_b_segmented_model(energy, famname, passmethod)

types = {};
b      = 1; types{end+1} = struct('fam_name', famname, 'passmethod', passmethod);
b_edge = 2; types{end+1} = struct('fam_name', 'edgeB', 'passmethod', 'IdentityPass');
b_pb   = 3; types{end+1} = struct('fam_name', 'physB', 'passmethod', 'IdentityPass');



% % dipole model 2019-10-31
% Average Dipole Model for TS at current 0680p00A for BD-006
% ===============================================
monomials = [0,1,2,3,4,5,6];
segmodel680A = [ ...
%  %--- model polynom_b (rz > 0). units: [m] for length, [rad] for angle and [m^(n-1)] for polynom_b ---
%  %type   len[m]   angle[deg]  PolyB(n=0)   PolyB(n=1)   PolyB(n=2)   PolyB(n=3)   PolyB(n=4)   PolyB(n=5)   PolyB(n=6)
b,         0.19600, 0.809210, +0.0000e+00, -1.5051e-01, -1.3411e+00, -8.5480e+00, -3.2288e+02, +2.4364e+04, +1.3442e+06;
b,         0.19200, 0.797075, +0.0000e+00, -1.4333e-01, -1.3238e+00, -4.4848e+00, -9.4175e+01, +1.0492e+04, -3.0360e+05;
b,         0.18200, 0.760100, +0.0000e+00, -1.3103e-01, -1.3407e+00, +2.6769e+00, +1.3657e+02, -1.3719e+04, -6.7430e+05;
b,         0.01000, 0.034635, +0.0000e+00, -1.5221e-01, -1.3089e+00, +5.5718e+00, +8.6858e+02, +1.1676e+04, -5.4735e+06;
b,         0.01000, 0.025100, +0.0000e+00, -9.6138e-02, -1.0707e+00, +9.4038e+00, +3.3497e+02, +1.1833e+04, -4.3069e+06;
b_edge,    0,0,0,0,0,0,0,0,0;
b,         0.01300, 0.022515, +0.0000e+00, -3.2419e-02, -1.3398e+00, +9.6988e+00, +3.0700e+00, +1.2751e+04, -2.6435e+06;
b,         0.01700, 0.020265, +0.0000e+00, -1.0579e-03, -1.6017e+00, +5.3622e+00, -5.4808e+01, +9.2551e+03, -9.9268e+05;
b,         0.02000, 0.015860, +0.0000e+00, +9.8323e-03, -1.5185e+00, +8.0931e-01, +5.2270e+01, +5.0616e+03, -3.3222e+05;
b,         0.03000, 0.013030, +0.0000e+00, +9.4421e-03, -1.0147e+00, -7.7297e-01, +1.1039e+02, +1.9387e+03, -3.2628e+05;
b,         0.05000, 0.007981, +2.4000e-06, +3.1574e-03, -3.5182e-01, -8.0587e-01, +4.0871e+01, +1.6753e+03, -6.6680e+04;
b_pb,      0,0,0,0,0,0,0,0,0
];

% % dipole model 2019-10-31
% Average Dipole Model for TS at current 0720p00A for BD-006
% ===============================================
% monomials = [0,1,2,3,4,5,6];
segmodel720A = [ ...
%  %--- model polynom_b (rz > 0). units: [m] for length, [rad] for angle and [m^(n-1)] for polynom_b ---
%  %type   len[m]   angle[deg]  PolyB(n=0)   PolyB(n=1)   PolyB(n=2)   PolyB(n=3)   PolyB(n=4)   PolyB(n=5)   PolyB(n=6)
b,         0.19600, 0.809310, +0.0000e+00, -1.5057e-01, -1.3489e+00, +3.5426e+00, +4.6779e+02, -4.8138e+04, -4.5704e+06;
b,         0.19200, 0.797170, +0.0000e+00, -1.4322e-01, -1.3539e+00, -7.5791e-01, +5.5284e+02, -7.6004e+02, -3.2266e+06;
b,         0.18200, 0.760015, +0.0000e+00, -1.3062e-01, -1.3035e+00, -1.4287e+00, -3.6527e+02, +1.0728e+04, +1.0776e+06;
b,         0.01000, 0.034585, +0.0000e+00, -1.5126e-01, -1.2272e+00, +8.3778e+00, -8.8515e+02, +5.9440e+03, +2.8081e+06;
b,         0.01000, 0.025070, +0.0000e+00, -9.5314e-02, -1.0361e+00, +1.1208e+01, -7.0128e+02, +6.5486e+03, +9.6980e+05;
b_edge,    0,0,0,0,0,0,0,0,0;
b,         0.01300, 0.022500, +0.0000e+00, -3.2109e-02, -1.3150e+00, +1.1201e+01, -6.9121e+02, +4.9732e+03, +1.0080e+06;
b,         0.01700, 0.020255, +0.0000e+00, -1.0145e-03, -1.5847e+00, +6.4288e+00, -4.2931e+02, +1.4334e+03, +1.0313e+06;
b,         0.02000, 0.015850, +0.0000e+00, +9.7912e-03, -1.5061e+00, +1.5059e+00, -1.5519e+02, -1.3646e+03, +8.2800e+05;
b,         0.03000, 0.013025, +0.0000e+00, +9.4060e-03, -1.0078e+00, -7.4783e-01, +3.3610e+01, -2.0242e+02, +1.2984e+05;
b,         0.05000, 0.007991, -4.5000e-06, +3.1653e-03, -3.4525e-01, -1.1005e+00, +4.6434e+01, +2.3571e+03, -2.3014e+05;
b_pb,      0,0,0,0,0,0,0,0,0
];

% curr = 698.87; % Current corresponding to 3GeV for BD-006
en = [0.1713193676247241, 0.2148871257902051, 0.2584670723411478, 0.7133049365351056, ...
          1.4305437411708284, 2.1637114800105932, 2.7663664536646859, 2.9373665192197982, ...
          3.1085142788516245, 3.4492497934322564, 4.0422030354440039, 4.2378599983404843, 4.4218162654372355];
curr = [40.310, 50.390, 60.460, 165.27, 330.54, 500.00, 640.00, 680.00, 720.00, 800.00, 942.05, 991.63, 1041.21];
p = polyfit(en, curr, 1);
curr_energy = p(1) * energy * 1e-9 + p(2);
% Current corresponding to 3GeV for BD-006 is 698.85A
segmodel = segmodel680A;
segmodel(:, 3:end) = segmodel680A(:, 3:end) + (curr_energy - 680.0)/(720.0-680.0) * (segmodel720A(:, 3:end) - segmodel680A(:,3:end));

% % % dipole model 2019-10-31
% % Average Dipole Model for TS at 3GeV for BD-006 (interpolated)
% % ===============================================
% % monomials = [0,1,2,3,4,5,6];
% segmodel3GeV = [ ...
% %  %--- model polynom_b (rz > 0). units: [m] for length, [rad] for angle and [m^(n-1)] for polynom_b ---
% %  %type   len[m]   angle[deg]  PolyB(n=0)   PolyB(n=1)   PolyB(n=2)   PolyB(n=3)   PolyB(n=4)   PolyB(n=5)   PolyB(n=6)
% b,         0.19600, 0.809257, +0.0000e+00, -1.5054e-01, -1.3448e+00, -2.8514e+00, +4.9654e+01, -9.7962e+03, -1.4425e+06;
% b,         0.19200, 0.797120, +0.0000e+00, -1.4328e-01, -1.3380e+00, -2.7288e+00, +2.1067e+02, +5.1905e+03, -1.6808e+06;
% b,         0.18200, 0.760060, +0.0000e+00, -1.3084e-01, -1.3232e+00, +7.4249e-01, -9.9878e+01, -2.2005e+03, +1.5113e+05;
% b,         0.01000, 0.034611, +0.0000e+00, -1.5176e-01, -1.2704e+00, +6.8939e+00, +4.2288e+01, +8.9753e+03, -1.5715e+06;
% b,         0.01000, 0.025086, +0.0000e+00, -9.5750e-02, -1.0544e+00, +1.0254e+01, -1.5327e+02, +9.3432e+03, -1.8207e+06;
% b_edge,    0,0,0,0,0,0,0,0,0;
% b,         0.01300, 0.022508, +0.0000e+00, -3.2273e-02, -1.3281e+00, +1.0407e+01, -3.2405e+02, +9.0864e+03, -9.2305e+05;
% b,         0.01700, 0.020260, +0.0000e+00, -1.0375e-03, -1.5937e+00, +5.8647e+00, -2.3126e+02, +5.5698e+03, -3.9056e+04;
% b,         0.02000, 0.015855, +0.0000e+00, +9.8129e-03, -1.5127e+00, +1.1375e+00, -4.5477e+01, +2.0338e+03, +2.1443e+05;
% b,         0.03000, 0.013028, +0.0000e+00, +9.4251e-03, -1.0114e+00, -7.6112e-01, +7.4214e+01, +9.2988e+02, -1.1137e+05;
% b,         0.05000, 0.007986, -8.5102e-07, +3.1611e-03, -3.4872e-01, -9.4469e-01, +4.3492e+01, +1.9965e+03, -1.4370e+05;
% b_pb,      0,0,0,0,0,0,0,0,0
% ];
% segmodel = segmodel3GeV;

% % dipole model 2017-08-31
% % =======================
% % filename: 2017-08-31_TS_Dipole_Model01_Sim_X=-85_85mm_Z=-1000_1000mm_Imc=680.1A.txt
% monomials = [0,1,2,3,4,5,6];
% segmodel = [ ...
%  %--- model polynom_b (rz > 0). units: [m] for length, [rad] for angle and [m^(n-1)] for polynom_b ---
%  %type   len[m]   angle[deg]  PolyB(n=0)   PolyB(n=1)   PolyB(n=2)   PolyB(n=3)   PolyB(n=4)   PolyB(n=5)   PolyB(n=6)
%  b,      0.1960 ,  +0.80828 ,  +0.00e+00 ,  -1.51e-01 ,  -1.35e+00 ,  -2.92e+00 ,  -1.08e+02 ,  -7.71e+03 ,  -3.84e+05 ;
%  b,      0.1920 ,  +0.79616 ,  +0.00e+00 ,  -1.44e-01 ,  -1.33e+00 ,  -2.08e+00 ,  -6.62e+01 ,  -2.56e+03 ,  -2.65e+05 ;
%  b,      0.1820 ,  +0.76057 ,  +0.00e+00 ,  -1.32e-01 ,  -1.32e+00 ,  -3.07e-01 ,  -1.16e+02 ,  +1.88e+03 ,  -5.06e+04 ;
%  b,      0.0100 ,  +0.03538 ,  +0.00e+00 ,  -1.58e-01 ,  -1.14e+00 ,  +7.26e+00 ,  -3.87e+02 ,  +2.90e+03 ,  -7.20e+04 ;
%  b,      0.0100 ,  +0.02550 ,  +0.00e+00 ,  -9.99e-02 ,  -8.58e-01 ,  +1.05e+01 ,  -5.61e+02 ,  +7.09e+03 ,  -2.19e+05 ;
%  b_edge, 0,0,0,0,0,0,0,0,0
%  b,      0.0130 ,  +0.02274 ,  +0.00e+00 ,  -3.60e-02 ,  -1.10e+00 ,  +1.26e+01 ,  -5.85e+02 ,  +5.36e+03 ,  -1.09e+05 ;
%  b,      0.0170 ,  +0.02020 ,  +0.00e+00 ,  -7.26e-03 ,  -1.24e+00 ,  +1.01e+01 ,  -3.70e+02 ,  +8.45e+02 ,  +4.57e+03 ;
%  b,      0.0200 ,  +0.01552 ,  +0.00e+00 ,  +1.59e-03 ,  -1.04e+00 ,  +5.18e+00 ,  -1.41e+02 ,  -4.95e+02 ,  +2.08e+04 ;
%  b,      0.0300 ,  +0.01276 ,  +0.00e+00 ,  +1.91e-03 ,  -6.16e-01 ,  +1.94e+00 ,  -3.42e+01 ,  -2.37e+02 ,  +6.99e+03 ;
%  b,      0.0500 ,  +0.00866 ,  +3.43e-05 ,  +1.04e-03 ,  -2.43e-01 ,  +3.98e-01 ,  -1.23e+00 ,  -5.04e+01 ,  +1.05e+03 ;
%  b_pb,   0,0,0,0,0,0,0,0,0
% ];

% converts deflection angle from degress to radians
segmodel(:,3) = segmodel(:,3) * (pi/180.0);

% turns deflection angle error off (convenient for having a nominal model with zero 4d closed orbit)
segmodel(:,4) = 0;

% builds half of the magnet model
b = zeros(1,size(segmodel,1));
maxorder = 1+max(monomials);
for i=1:size(segmodel,1)
    type = types{segmodel(i,1)};
    if strcmpi(type.passmethod, 'IdentityPass')
        b(i) = marker(type.fam_name, 'IdentityPass');
    else
        PolyB = zeros(1,maxorder); PolyA = zeros(1,maxorder);
        PolyB(monomials+1) = segmodel(i,4:end);
        b(i) = rbend_sirius(type.fam_name, segmodel(i,2), segmodel(i,3), 0, 0, 0, 0, 0, PolyA, PolyB, passmethod);
    end
end

% builds entire magnet model, inserting additional markers
model_length = 2*sum(segmodel(:,2));
mb = marker('mB', 'IdentityPass');
model = [fliplr(b), mb, b];
